---
# ============================================
# Playbook AWX: Cinder Volume Backup (One-Shot) - MULTI-TENANT
# Eseguito dallo schedule per fare backup automatici
# VERSIONE CORRETTA: Logica 1 FULL + 6 INCREMENTALI
# ============================================

- name: Create Cinder Volume Backup
  hosts: localhost
  connection: local
  gather_facts: true
  environment:
    no_proxy: "172.16.17.253,10.1.98.150,10.1.98.74,localhost,127.0.0.1,awx.k8s-prod.tcosmilano.local,awx-prod-service.awx.svc,.local,.svc,.svc.cluster.local,milano.cloudopen.tim.it"
    NO_PROXY: "172.16.17.253,10.1.98.150,10.1.98.74,localhost,127.0.0.1,awx.k8s-prod.tcosmilano.local,awx-prod-service.awx.svc,.local,.svc,.svc.cluster.local,milano.cloudopen.tim.it"
  vars:
    awx_host: "https://services.linuxwall.it"
    awx_validate_certs: false
    retention_days: 21
    first_week_days: 7
  vars_files:
    - vars/awx_credentials.yaml
    
  tasks:
    # =============================================
    # 1. VALIDAZIONE INPUT
    # =============================================
    - name: Validate required variables
      assert:
        that:
          - volume_id is defined and volume_id | length > 0
          - tenant_name is defined and tenant_name | length > 0
          - retention_days is defined
          - openstack_auth_url is defined
        fail_msg: "ERROR: Missing required variables"

    # =============================================
    # 2. AUTHENTICATE OPENSTACK (MULTI-TENANT)
    # =============================================
    - name: Determine authentication method
      set_fact:
        use_project_id: "{{ openstack_project_id is defined and openstack_project_id != '' }}"

    - name: Authenticate with project ID
      uri:
        url: "{{ openstack_auth_url }}/v3/auth/tokens"
        method: POST
        body:
          auth:
            identity:
              methods: [password]
              password:
                user:
                  name: "{{ openstack_username }}"
                  domain: { name: "{{ openstack_domain_name | default('Default') }}" }
                  password: "{{ openstack_password }}"
            scope:
              project: { id: "{{ openstack_project_id }}" }
        body_format: json
        status_code: [201, 401, 404]
        return_content: yes
        validate_certs: no
      register: auth_with_id
      when: use_project_id | bool
      ignore_errors: yes

    - name: Authenticate with project name
      uri:
        url: "{{ openstack_auth_url }}/v3/auth/tokens"
        method: POST
        body:
          auth:
            identity:
              methods: [password]
              password:
                user:
                  name: "{{ openstack_username }}"
                  domain: { name: "{{ openstack_domain_name | default('Default') }}" }
                  password: "{{ openstack_password }}"
            scope:
              project:
                name: "{{ openstack_project_name }}"
                domain: { name: "{{ openstack_domain_name | default('Default') }}" }
        body_format: json
        status_code: [201, 401, 404]
        return_content: yes
        validate_certs: no
      register: auth_with_name
      when: not (use_project_id | bool)
      ignore_errors: yes

    - name: Set unified auth response
      set_fact:
        auth_response: "{{ auth_with_id if (use_project_id | bool) else auth_with_name }}"
      when: (auth_with_id is defined and auth_with_id.status == 201) or (auth_with_name is defined and auth_with_name.status == 201)

    - name: Handle non-existent tenant
      when: auth_response is not defined
      block:
        - name: Log missing tenant
          debug: { msg: "⚠ TENANT NON TROVATO. Pulizia schedule AWX..." }
        - name: Get all schedules from AWX
          uri:
            url: "{{ awx_host }}/api/v2/schedules/"
            method: GET
            url_username: "{{ awx_user }}"
            url_password: "{{ awx_password }}"
            force_basic_auth: yes
            validate_certs: no
          register: awx_schedules_tenant
        - name: Delete schedules for missing tenant
          uri:
            url: "{{ awx_host }}/api/v2/schedules/{{ item.id }}/"
            method: DELETE
            url_username: "{{ awx_user }}"
            url_password: "{{ awx_password }}"
            force_basic_auth: yes
            status_code: [204, 404]
          loop: "{{ awx_schedules_tenant.json.results | selectattr('name', 'search', tenant_name) | list }}"
        - meta: end_play

    - name: Extract auth facts
      set_fact:
        os_auth_token: "{{ auth_response.x_subject_token }}"
        cinder_endpoint: "{{ auth_response.json.token.catalog | selectattr('type', 'equalto', 'volumev3') | map(attribute='endpoints') | first | selectattr('interface', 'equalto', 'public') | map(attribute='url') | first }}"

    # =============================================
    # 4. VERIFICA ESISTENZA VOLUME
    # =============================================
    - name: Check if volume exists via Cinder API
      uri:
        url: "{{ cinder_endpoint }}/volumes/{{ volume_id }}"
        method: GET
        headers: { X-Auth-Token: "{{ os_auth_token }}" }
        validate_certs: no
        status_code: [200, 404]
      register: volume_response

    - name: Handle non-existent volume
      when: volume_response.status == 404
      block:
        - name: Log missing volume
          debug: { msg: "⚠ VOLUME NON TROVATO. Pulizia schedule AWX..." }
        - name: Get schedules for volume
          uri:
            url: "{{ awx_host }}/api/v2/schedules/"
            method: GET
            url_username: "{{ awx_user }}"
            url_password: "{{ awx_password }}"
            force_basic_auth: yes
          register: awx_schedules_vol
        - name: Delete schedules for missing volume
          uri:
            url: "{{ awx_host }}/api/v2/schedules/{{ item.id }}/"
            method: DELETE
            url_username: "{{ awx_user }}"
            url_password: "{{ awx_password }}"
            force_basic_auth: yes
            status_code: [204, 404]
          loop: "{{ awx_schedules_vol.json.results | selectattr('name', 'search', volume_id) | list }}"
        - meta: end_play

    - name: Set volume facts
      set_fact:
        volume_name: "{{ volume_response.json.volume.name }}"
        backup_force_flag: "{{ (volume_response.json.volume.attachments | length > 0) }}"

    # =============================================
    # 7. ANALISI BACKUP PADRE/FIGLI (CORRETTA)
    # =============================================
    - name: Get all backups for this volume
      uri:
        url: "{{ cinder_endpoint }}/backups/detail"
        method: GET
        headers: { X-Auth-Token: "{{ os_auth_token }}" }
        validate_certs: no
      register: existing_backups_response

    - name: Filter available backups
      set_fact:
        volume_existing_backups: "{{ existing_backups_response.json.backups | selectattr('volume_id', 'equalto', volume_id) | selectattr('status', 'equalto', 'available') | list }}"

    - name: Sort parent backups (FULL) newest first
      set_fact:
        sorted_parent_backups: "{{ volume_existing_backups | rejectattr('is_incremental', 'equalto', true) | sort(attribute='created_at', reverse=True) | list }}"

    - name: Analyze newest parent and count ITS specific children
      set_fact:
        is_first_backup: "{{ sorted_parent_backups | length == 0 }}"

    - name: Count children ONLY for the newest parent
      set_fact:
        newest_parent_id: "{{ sorted_parent_backups[0].id }}"
        current_children_count: "{{ volume_existing_backups | selectattr('is_incremental', 'equalto', true) | selectattr('parent_id', 'defined') | selectattr('parent_id', 'equalto', sorted_parent_backups[0].id) | list | length }}"
      when: not is_first_backup

    - name: Decide backup type
      set_fact:
        is_incremental: "{{ not is_first_backup and (current_children_count | int < 6) }}"
        last_backup_id: "{{ newest_parent_id | default('') }}"
        backup_decision_reason: "{{ 'Padre ' ~ newest_parent_id[:8] ~ ' ha ' ~ current_children_count ~ ' figli (< 6) -> INCREMENTALE' if (not is_first_backup and current_children_count | int < 6) else 'Nessun padre o limite 6 figli raggiunto -> FULL' }}"

    - name: Display backup decision
      debug:
        msg: "DECISIONE: {{ 'INCREMENTALE' if is_incremental else 'FULL' }} | Motivo: {{ backup_decision_reason }}"

    # =============================================
    # 8. CREA BACKUP (API REST)
    # =============================================
    - name: Generate final backup name
      set_fact:
        final_backup_name: "{{ ansible_date_time.year }}_{{ '%02d' | format(ansible_date_time.month | int) }}_{{ '%02d' | format(ansible_date_time.day | int) }}_{{ volume_name | regex_replace('[^a-zA-Z0-9_-]', '_') }}_{{ tenant_name | regex_replace('[^a-zA-Z0-9_-]', '_') }}"

    - name: Create volume backup via Cinder API
      uri:
        url: "{{ cinder_endpoint }}/backups"
        method: POST
        headers:
          X-Auth-Token: "{{ os_auth_token }}"
          Content-Type: "application/json"
        body:
          backup:
            volume_id: "{{ volume_id }}"
            name: "{{ final_backup_name }}"
            description: "Backup {{ 'INC' if is_incremental else 'FULL' }} - Tenant: {{ tenant_name }}"
            force: "{{ backup_force_flag }}"
            incremental: "{{ is_incremental }}"
            parent_id: "{{ last_backup_id if is_incremental else omit }}"
        body_format: json
        status_code: [202]
        validate_certs: no
      register: backup_create_response

    - name: Wait for backup completion
      uri:
        url: "{{ cinder_endpoint }}/backups/{{ backup_create_response.json.backup.id }}"
        method: GET
        headers: { X-Auth-Token: "{{ os_auth_token }}" }
        validate_certs: no
      register: backup_status_response
      until: backup_status_response.json.backup.status in ['available', 'error']
      retries: 60
      delay: 10

    - name: Final Check
      fail: { msg: "Backup failed!" }
      when: backup_status_response.json.backup.status == 'error'

    # =============================================
    # 10. GESTIONE RETENTION (MAX 3 PADRI)
    # =============================================
    - name: Refresh backups for retention
      uri:
        url: "{{ cinder_endpoint }}/backups/detail"
        method: GET
        headers: { X-Auth-Token: "{{ os_auth_token }}" }
        validate_certs: no
      register: final_bk_list

    - name: Identify parents for cleanup
      set_fact:
        parents_retention: "{{ final_bk_list.json.backups | selectattr('volume_id', 'equalto', volume_id) | rejectattr('is_incremental', 'equalto', true) | sort(attribute='created_at') | list }}"

    - name: Delete oldest parents if more than 3
      uri:
        url: "{{ cinder_endpoint }}/backups/{{ item.id }}"
        method: DELETE
        headers: { X-Auth-Token: "{{ os_auth_token }}" }
        validate_certs: no
        status_code: [204, 404]
      loop: "{{ parents_retention[:-3] }}"
      when: parents_retention | length > 3